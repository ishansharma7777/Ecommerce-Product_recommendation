<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Recommendation System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .explanation-card {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Product Recommendation System</h1>
            <p class="text-gray-600">Discover products with AI-powered recommendations and explanations</p>
            
            <!-- Navigation -->
            <div class="mt-4 mb-4">
                <button 
                    onclick="fetchProducts()" 
                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg mr-2 transition duration-200"
                >
                    Home
                </button>
            </div>
            
            <!-- Search Bar -->
            <div class="mt-6 max-w-xl mx-auto">
                <div class="flex shadow-md rounded-lg overflow-hidden">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Search for products by name, brand, category..." 
                        class="flex-grow px-4 py-3 focus:outline-none"
                    >
                    <button 
                        onclick="searchProducts()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 transition duration-200"
                    >
                        Search
                    </button>
                </div>
            </div>
        </header>

        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Product Catalog</h2>
            <div id="products-container" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Products will be loaded here -->
                <div class="animate-pulse bg-white rounded-lg shadow-md p-4">
                    <div class="h-48 bg-gray-300 rounded mb-4"></div>
                    <div class="h-6 bg-gray-300 rounded mb-2 w-3/4"></div>
                    <div class="h-4 bg-gray-300 rounded mb-4 w-1/2"></div>
                    <div class="h-10 bg-gray-300 rounded"></div>
                </div>
                <div class="animate-pulse bg-white rounded-lg shadow-md p-4">
                    <div class="h-48 bg-gray-300 rounded mb-4"></div>
                    <div class="h-6 bg-gray-300 rounded mb-2 w-3/4"></div>
                    <div class="h-4 bg-gray-300 rounded mb-4 w-1/2"></div>
                    <div class="h-10 bg-gray-300 rounded"></div>
                </div>
                <div class="animate-pulse bg-white rounded-lg shadow-md p-4">
                    <div class="h-48 bg-gray-300 rounded mb-4"></div>
                    <div class="h-6 bg-gray-300 rounded mb-2 w-3/4"></div>
                    <div class="h-4 bg-gray-300 rounded mb-4 w-1/2"></div>
                    <div class="h-10 bg-gray-300 rounded"></div>
                </div>
            </div>
        </div>

        <div id="recommendations-section" class="hidden mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Recommended Products</h2>
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4" id="selected-product-name"></h3>
                <p class="text-gray-600 mb-4" id="selected-product-description"></p>
            </div>
            <div id="recommendations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Recommendations will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Use Supabase REST API directly
        const SUPABASE_URL = 'https://mqztueomqedvooewmzxf.supabase.co/rest/v1';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xenR1ZW9tcWVkdm9vZXdtenhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjg0MjEsImV4cCI6MjA3NTgwNDQyMX0.05_PRVQqSnhxTDL2_IDB3_WNwe5fPuCtqZ_fvf21k4U';
        const OPENAI_API_KEY = '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';
        let selectedProduct = null;
        
        // Function to show search interface
        function showSearchInterface() {
            document.getElementById('search-input').focus();
        }
        
        // Track user behavior
        async function trackUserBehavior(productId, behaviorType) {
            const sessionId = initSession();
            
            try {
                console.log(`Tracking behavior: ${behaviorType} for product ${productId}`);
                // Use UPSERT instead of POST to avoid conflicts
                await fetch(`${SUPABASE_URL}/rest/v1/user_behaviors`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        product_id: productId,
                        behavior_type: behaviorType,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (err) {
                console.error('Error tracking user behavior:', err);
                // Continue execution even if tracking fails
            }
        }

        // Helper function to generate a session ID
        function generateSessionId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Helper function to get a cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Helper function to set a cookie
        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = `expires=${date.toUTCString()}`;
            document.cookie = `${name}=${value};${expires};path=/`;
        }

        // Initialize session
        function initSession() {
            let sessionId = getCookie('session_id');
            if (!sessionId) {
                sessionId = generateSessionId();
                setCookie('session_id', sessionId, 30); // 30 days
            }
            return sessionId;
        }

        // Fetch personalized recommendations based on user behavior
        async function fetchProducts() {
            const container = document.getElementById('products-container');
            const sessionId = initSession();
            
            // Show loading state
            container.innerHTML = `
                <div class="col-span-full flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                </div>
            `;
            
            try {
                console.log("Fetching user behavior data...");
                // First, get user behavior data
                const behaviorResponse = await fetch(`${SUPABASE_URL}/user_behaviors?session_id=eq.${sessionId}&order=timestamp.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!behaviorResponse.ok) {
                    throw new Error(`HTTP error! status: ${behaviorResponse.status}`);
                }
                
                const behaviors = await behaviorResponse.json();
                console.log("User behaviors:", behaviors);
                
                // If user has previous behaviors, fetch recommendations based on those
                if (Array.isArray(behaviors) && behaviors.length > 0) {
                    // Get unique product IDs from user behaviors
                    const viewedProductIds = [...new Set(behaviors.map(b => b.product_id))];
                    
                    // Hide product catalog and show only recommendations
                    document.querySelector('.mb-8').style.display = 'none'; // Hide product catalog section
                    
                    if (viewedProductIds.length > 0) {
                        // Fetch recommendations for products the user has interacted with
                        const recommendationsResponse = await fetch(
                            `${SUPABASE_URL}/recommendations?source_product_id=in.(${viewedProductIds.join(',')})&order=recommendation_score.desc`, {
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        });
                        
                        if (!recommendationsResponse.ok) {
                            throw new Error(`HTTP error! status: ${recommendationsResponse.status}`);
                        }
                        
                        const recommendations = await recommendationsResponse.json();
                        console.log("Personalized recommendations:", recommendations);
                        
                        if (Array.isArray(recommendations) && recommendations.length > 0) {
                            // Get recommended product IDs
                            const recommendedProductIds = [...new Set(recommendations.map(r => r.recommended_product_id))];
                            
                            // Fetch the actual product details
                            const productsResponse = await fetch(
                                `${SUPABASE_URL}/products?id=in.(${recommendedProductIds.join(',')})`, {
                                headers: {
                                    'apikey': SUPABASE_KEY,
                                    'Authorization': `Bearer ${SUPABASE_KEY}`
                                }
                            });
                            
                            if (!productsResponse.ok) {
                                throw new Error(`HTTP error! status: ${productsResponse.status}`);
                            }
                            
                            const products = await productsResponse.json();
                            console.log("Recommended products:", products);
                            
                            // Display personalized recommendations
                            if (Array.isArray(products) && products.length > 0) {
                                // Add recommendation explanations to products
                                const productsWithExplanations = products.map(product => {
                                    const recommendation = recommendations.find(r => r.recommended_product_id === product.id);
                                    return {
                                        ...product,
                                        explanation: recommendation ? recommendation.explanation : null,
                                        score: recommendation ? recommendation.recommendation_score : 0
                                    };
                                });
                                
                                displayProducts(productsWithExplanations);
                                return;
                            }
                        }
                    }
                }
                
                // If no recommendations found or no user behavior, show empty state
                container.innerHTML = `
                    <div class="col-span-full text-center p-8">
                        <h2 class="text-xl font-semibold mb-4">Welcome to our Product Recommendations</h2>
                        <p class="text-gray-600 mb-6">Search for products to get personalized recommendations based on your interests.</p>
                        <div class="flex justify-center">
                            <button onclick="showSearchInterface()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-lg">
                                Start Searching
                            </button>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Error fetching recommendations:', err);
                container.innerHTML = `
                    <div class="col-span-full text-center p-8">
                        <p class="text-red-500">Failed to load recommendations. Please try again later.</p>
                    </div>
                `;
            }
            
        // Function to show search interface
        function showSearchInterface() {
            document.getElementById('search-input').focus();
        }
        
        // Track user behavior
        async function trackUserBehavior(productId, behaviorType) {
            const sessionId = initSession();
            
            try {
                console.log(`Tracking behavior: ${behaviorType} for product ${productId}`);
                await fetch(`${SUPABASE_URL}/user_behaviors`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        product_id: productId,
                        behavior_type: behaviorType,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (err) {
                console.error('Error tracking user behavior:', err);
            }
        }
        
    // Generate enhanced explanation using OpenAI
    window.generateEnhancedExplanation = async function(sourceProduct, recommendedProduct, score) {
            try {
                console.log("Generating enhanced explanation for", sourceProduct.name, "and", recommendedProduct.name);
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "system",
                                content: "You are a helpful product recommendation assistant. Generate a brief, personalized explanation (max 30 words) for why a customer might like a recommended product based on another product they viewed."
                            },
                            {
                                role: "user",
                                content: `Source product: ${JSON.stringify({
                                    name: sourceProduct.name,
                                    description: sourceProduct.description,
                                    category: sourceProduct.category
                                })}\nRecommended product: ${JSON.stringify({
                                    name: recommendedProduct.name,
                                    description: recommendedProduct.description,
                                    category: recommendedProduct.category
                            })}\nRecommendation score: ${score}`
                        }
                    ],
                    max_tokens: 60,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content.trim();
        } catch (err) {
            console.error('Error generating enhanced explanation:', err);
            return null;
        }
    }
    
    // Mock products for fallback
    const mockProducts = [
        {
            id: 1,
            name: "Smartphone X",
            description: "Latest smartphone with advanced features",
            category: "Electronics",
            price: 999.99
        },
                        {
                            id: 2,
                            name: "Laptop Pro",
                            description: "Powerful laptop for professionals",
                            category: "Electronics",
                            price: 1499.99
                        },
                        {
                            id: 3,
                            name: "Wireless Headphones",
                            description: "Premium noise-cancelling headphones",
                            category: "Audio",
                            price: 299.99
                        },
                        {
                            id: 4,
                            name: "Smart Watch",
                            description: "Fitness tracker with health monitoring",
                            category: "Wearables",
                            price: 249.99
                        }
                    ];
        }

        // Display products in the container
        function displayProducts(products, headerText = null) {
            const container = document.getElementById('products-container');
            
            // Clear container
            container.innerHTML = '';
            
            // Add header if provided
            if (headerText) {
                container.innerHTML = `
                    <div class="col-span-full mb-4">
                        <h2 class="text-2xl font-bold">${headerText}</h2>
                        <p class="text-gray-600">Based on your previous activity</p>
                    </div>
                `;
            }
            
            if (!products || products.length === 0) {
                container.innerHTML += `
                    <div class="col-span-full text-center p-8">
                        <p class="text-gray-500">No products available.</p>
                    </div>
                `;
                return;
            }

            // Check if products have explanations (personalized recommendations)
            const hasExplanations = products.some(product => product.explanation);
            
            // Add header for personalized recommendations if applicable
            if (hasExplanations && !headerText) {
                container.innerHTML = `
                    <div class="col-span-full mb-4">
                        <h2 class="text-2xl font-bold">Recommended for you</h2>
                        <p class="text-gray-600">Based on your previous activity</p>
                    </div>
                `;
            }

            // Append product cards
            container.innerHTML += products.map(product => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                    <img src="${product.image_url || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200" viewBox="0 0 300 200"><rect width="300" height="200" fill="#f0f0f0"/><text x="50%" y="50%" font-family="Arial" font-size="24" text-anchor="middle" dominant-baseline="middle" fill="#999">${product.name}</text></svg>'}" 
                         alt="${product.name}" 
                         class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description}</p>
                        ${product.explanation ? `
                        <div class="explanation-card p-3 rounded-lg mb-3">
                            <p class="text-sm italic">"${product.explanation}"</p>
                            <div class="mt-1 flex items-center">
                                <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded">
                                    Match: ${Math.round(product.score * 100)}%
                                </span>
                            </div>
                        </div>
                        ` : ''}
                        <div class="flex items-center justify-between">
                            <span class="text-xl font-bold text-green-600">$${product.price}</span>
                            <button 
                                onclick="getRecommendations(${product.id})" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                                Get Recommendations
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get recommendations for a product directly from Supabase
        async function getRecommendations(productId) {
            const recommendationsSection = document.getElementById('recommendations-section');
            const container = document.getElementById('recommendations-container');
            
            // Show loading state
            recommendationsSection.classList.remove('hidden');
            container.innerHTML = `
                <div class="col-span-full flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                </div>
            `;
            
            try {
                // Track view behavior
                await trackUserBehavior(productId, 'view');
                
                // Get the selected product first
                const productResponse = await fetch(`${SUPABASE_URL}/products?id=eq.${productId}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!productResponse.ok) {
                    throw new Error(`HTTP error! status: ${productResponse.status}`);
                }
                
                const products = await productResponse.json();
                if (!products || products.length === 0) {
                    throw new Error('Product not found');
                }
                
                selectedProduct = products[0];
                
                // Update selected product info
                const selectedProductName = document.getElementById('selected-product-name');
                const selectedProductDescription = document.getElementById('selected-product-description');
                selectedProductName.textContent = selectedProduct.name || 'Product';
                selectedProductDescription.textContent = selectedProduct.description || 'No description available';
                
                // Get recommendations from the recommendations table
                const recResponse = await fetch(`${SUPABASE_URL}/recommendations?source_product_id=eq.${productId}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!recResponse.ok) {
                    throw new Error(`HTTP error! status: ${recResponse.status}`);
                }
                
                let recommendations = await recResponse.json();
                
                if (recommendations && recommendations.length > 0) {
                    // Get the recommended product details
                    const recommendedProductIds = recommendations.map(rec => rec.recommended_product_id);
                    const recommendedProductsResponse = await fetch(`${SUPABASE_URL}/products?id=in.(${recommendedProductIds.join(',')})`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });
                    
                    if (!recommendedProductsResponse.ok) {
                        throw new Error(`HTTP error! status: ${recommendedProductsResponse.status}`);
                    }
                    
                    const recommendedProducts = await recommendedProductsResponse.json();
                    
                    // Combine recommendation data with product details
                    const fullRecommendations = recommendations.map(rec => {
                        const product = recommendedProducts.find(p => p.id === rec.recommended_product_id);
                        return {
                            product: product,
                            score: rec.recommendation_score,
                            explanation: rec.explanation
                        };
                    });
                    
                    // Process only first 3 recommendations for enhanced explanations
                    const enhancedRecommendations = [];
                    
                    for (let i = 0; i < Math.min(fullRecommendations.length, 3); i++) {
                        const rec = fullRecommendations[i];
                        if (rec.product && selectedProduct) {
                            try {
                                console.log("Skipping enhanced explanation generation");
                                // Skip enhanced explanation for now
                                const enhancedExplanation = "Based on your interest in this product";
                                
                                if (enhancedExplanation) {
                                    rec.explanation = enhancedExplanation;
                                }
                            } catch (err) {
                                console.error('Error enhancing explanation:', err);
                            }
                        }
                        enhancedRecommendations.push(rec);
                    }
                    
                    // Add any remaining recommendations without enhanced explanations
                    if (fullRecommendations.length > 3) {
                        enhancedRecommendations.push(...fullRecommendations.slice(3));
                    }
                    
                    // Display recommendations
                    displayRecommendations(enhancedRecommendations);
                } else {
                    // Get products in the same category as fallback
                    const fallbackResponse = await fetch(
                        `${SUPABASE_URL}/products?category=eq.${encodeURIComponent(selectedProduct.category)}&id=neq.${productId}&limit=4`, {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    });
                    
                    if (!fallbackResponse.ok) {
                        throw new Error(`Error fetching fallback recommendations: ${fallbackResponse.statusText}`);
                    }
                    
                    const fallbackProducts = await fallbackResponse.json();
                    
                    if (fallbackProducts && fallbackProducts.length > 0) {
                        // Create synthetic recommendations
                        const fallbackRecommendations = fallbackProducts.map(product => ({
                            product: product,
                            score: 0.7, // Default score for fallbacks
                            explanation: `Also in the ${selectedProduct.category} category`
                        }));
                        displayRecommendations(fallbackRecommendations);
                    } else {
                        throw new Error('No recommendations found');
                    }
                }
                
                // Scroll to recommendations
                recommendationsSection.scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                console.error('Error fetching recommendations:', err);
                container.innerHTML = `
                    <div class="col-span-full text-center p-8">
                        <p class="text-red-500">Failed to load recommendations. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Search for products directly from Supabase
        async function searchProducts() {
            const searchInput = document.getElementById('search-input').value.trim();
            if (!searchInput) return;
            
            const productsContainer = document.getElementById('products-container');
            const recommendationsSection = document.getElementById('recommendations-section');
            
            // Show loading state
            productsContainer.innerHTML = `
                <div class="col-span-full flex justify-center items-center p-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                </div>
            `;
            
            // Hide recommendations section
            recommendationsSection.classList.add('hidden');
            
            try {
                console.log(`Searching with query: ${searchInput}`);
                // Track search behavior
                await trackUserBehavior(0, `search:${searchInput}`);
                
                // Search using Supabase's text search capabilities
                const response = await fetch(`${SUPABASE_URL}/products?or=(name.ilike.%25${encodeURIComponent(searchInput)}%25,description.ilike.%25${encodeURIComponent(searchInput)}%25,category.ilike.%25${encodeURIComponent(searchInput)}%25)`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Search response:', data);
                
                if (data && data.length > 0) {
                    // Display search results
                    displayProducts(data);
                } else {
                    productsContainer.innerHTML = `
                        <div class="col-span-full text-center p-8">
                            <p class="text-gray-500">No products found matching "${searchInput}".</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error searching products:', err);
                productsContainer.innerHTML = `
                    <div class="col-span-full text-center p-8">
                        <p class="text-red-500">Failed to search products. Please try again later.</p>
                    </div>
                `;
            }
        }
        
        // Display search results
        function displaySearchResults(results) {
            const container = document.getElementById('products-container');
            
            container.innerHTML = results.map(result => {
                const product = result.product;
                const recommendations = result.recommendations;
                
                return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                        <img src="https://via.placeholder.com/300x200?text=Product+Image" 
                             alt="${product.name}" 
                             class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-2">${product.description}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-blue-600">${product.category}</span>
                                <button 
                                    onclick="getRecommendations(${product.id})" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                                    Get Recommendations
                                </button>
                            </div>
                        </div>
                        ${recommendations && recommendations.length > 0 ? `
                            <div class="p-4 bg-gray-50 border-t">
                                <h4 class="font-medium text-gray-700 mb-2">Quick Recommendations:</h4>
                                <div class="space-y-2">
                                    ${recommendations.slice(0, 2).map(rec => `
                                        <div class="flex items-start space-x-2">
                                            <div class="w-10 h-10 flex-shrink-0">
                                                <img src="${rec.image_url || 'https://via.placeholder.com/40x40?text=+'}" 
                                                     class="w-full h-full object-cover rounded">
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium">${rec.name}</p>
                                                <p class="text-xs text-gray-500 line-clamp-1">${rec.explanation}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Display recommendations
        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendations-container');
            const selectedProductName = document.getElementById('selected-product-name');
            const selectedProductDescription = document.getElementById('selected-product-description');
            
            if (!recommendations || recommendations.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center p-8">
                        <p class="text-gray-500">No recommendations available.</p>
                    </div>
                `;
                return;
            }
            
            // Update selected product info if available
            const productResponse = recommendations[0]?.product;
            if (productResponse) {
                selectedProductName.textContent = productResponse.name || 'Product';
                selectedProductDescription.textContent = productResponse.description || 'No description available';
            }
            
            // Display recommendations
            container.innerHTML = recommendations.map(rec => {
                // Handle potential missing data gracefully
                const product = rec.product || {};
                const price = product.price || 0;
                const score = rec.score || 0;
                const name = product.name || 'Product';
                const description = product.description || 'No description available';
                const imageUrl = product.image_url || '';
                
                return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden card-hover">
                    <img src="${imageUrl || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200" viewBox="0 0 300 200"><rect width="300" height="200" fill="#f0f0f0"/><text x="50%" y="50%" font-family="Arial" font-size="24" text-anchor="middle" dominant-baseline="middle" fill="#999">${name}</text></svg>'}" 
                         alt="${name}" 
                         class="w-full h-48 object-cover">
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${name}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${description}</p>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xl font-bold text-green-600">$${price}</span>
                            <span class="text-sm font-medium text-blue-500">${Math.round(score * 100)}% match</span>
                        </div>
                        <div class="explanation-card p-3 rounded-lg">
                            <p class="text-sm italic">"${rec.explanation || 'Recommended based on your interests'}"</p>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initSession();
            fetchProducts();
            
            // Add event listener for search form
            const searchForm = document.getElementById('search-form');
            if (searchForm) {
                searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    searchProducts();
                });
            }
            
            // Add event listener for search button
            const searchButton = document.getElementById('search-button');
            if (searchButton) {
                searchButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    searchProducts();
                });
            }
        });
    </script>
</body>
</html>
